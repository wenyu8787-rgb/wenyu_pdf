<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF æ–‡ä»¶å·¥å…·ç®±</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ PDF è™•ç†å‡½å¼åº« (pdf-lib) -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <!-- è¼‰å…¥ PDF æ¸²æŸ“å‡½å¼åº« (pdf.js) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.5.207/pdf.min.js"></script>
    <!-- è¼‰å…¥ JSZip å‡½å¼åº« (ç”¨æ–¼å°‡åœ–ç‰‡æ‰“åŒ…æˆ ZIP æª”) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* è¨­å®šå…¨åŸŸå­—é«”ç‚º Interï¼Œä¸¦æä¾› fallback */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* è‡ªå®šç¾© loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* éš±è— color input çš„é è¨­é‚Šæ¡† */
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 0.375rem; /* rounded-md */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden">
        
        <!-- æ¨™é ­ -->
        <header class="p-6 bg-indigo-600 text-white shadow-lg">
            <h1 class="text-3xl font-bold mb-1">PDF è¬ç”¨å·¥å…·ç®±</h1>
            <p class="text-indigo-200 text-sm">ç·šä¸Šæ–‡ä»¶è™•ç†å°ˆå®¶ (9 ç¨®å¯¦ç”¨åŠŸèƒ½)</p>
        </header>

        <!-- å·¥å…·å°èˆªåˆ— -->
        <nav class="p-4 border-b border-gray-200 bg-gray-50">
            <div id="tool-nav" class="flex flex-wrap gap-2 sm:gap-4 justify-center">
                <!-- æŒ‰éˆ•å°‡ç”± JS å‹•æ…‹æ·»åŠ  -->
            </div>
        </nav>

        <!-- å·¥å…·å…§å®¹å€ -->
        <main id="tool-container" class="p-6 sm:p-8">
            <!-- å…§å®¹å°‡æ ¹æ“šé¸æ“‡çš„å·¥å…·å‹•æ…‹è¼‰å…¥ -->
        </main>

    </div>

    <script>
        // ç¢ºä¿å‡½å¼åº«å·²è¼‰å…¥
        const { PDFDocument, rgb, degrees, StandardFonts } = window.PDFLib;
        const pdfjsLib = window.pdfjsLib;
        const JSZip = window.JSZip;

        // è¨­å®š pdf.js worker çš„è·¯å¾‘
        if (pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.5.207/pdf.worker.min.js';
        }

        // --- è¼”åŠ©å‡½æ•¸ï¼šå°‡ Hex é¡è‰²ç¢¼è½‰æ›ç‚º pdf-lib çš„ rgb å‡½å¼åƒæ•¸ (0 åˆ° 1 ä¹‹é–“) ---
        function hexToRgb(hex) {
            const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, function(m, r, g, b) {
                return r + r + g + g + b + b;
            });

            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? rgb(
                parseInt(result[1], 16) / 255,
                parseInt(result[2], 16) / 255,
                parseInt(result[3], 16) / 255
            ) : rgb(0.5, 0.5, 0.5); // å¦‚æœè½‰æ›å¤±æ•—ï¼Œé è¨­ç‚ºç°è‰²
        }


        // æ›´æ–°å¾Œçš„å·¥å…·åˆ—è¡¨ (åŒ…å« 9 å€‹åŠŸèƒ½)
        const tools = {
            'pdf_split': { name: 'PDF åˆ†å‰²', icon: 'âœ‚ï¸', status: 'å¯¦éš›é‹ä½œ', description: 'é¸æ“‡ä¸€å€‹ PDF æª”ä¸¦æŒ‡å®šè¦ä¿ç•™çš„é ç¢¼ç¯„åœã€‚', fileType: 'application/pdf', multiple: false, label: 'è«‹é¸æ“‡è¦åˆ†å‰²çš„ PDF æª”æ¡ˆ' },
            'pdf_merge': { name: 'PDF åˆä½µ', icon: 'ğŸ”—', status: 'å¯¦éš›é‹ä½œ', description: 'é¸æ“‡å¤šå€‹ PDF æª”ï¼Œå°‡å®ƒå€‘åˆä½µæˆä¸€å€‹å–®ä¸€æª”æ¡ˆã€‚', fileType: 'application/pdf', multiple: true, label: 'è«‹é¸æ“‡è¦åˆä½µçš„å¤šå€‹ PDF æª”æ¡ˆ' },
            'pdf_to_image': { name: 'PDF è½‰åœ–ç‰‡ (ZIP)', icon: 'ğŸ–¼ï¸', status: 'å¯¦éš›é‹ä½œ', description: 'å°‡ PDF çš„**æ¯ä¸€é **è½‰æ›ç‚º PNG åœ–ç‰‡ä¸¦æ‰“åŒ…æˆ ZIP æª”ä¸‹è¼‰ã€‚', fileType: 'application/pdf', multiple: false, label: 'è«‹é¸æ“‡è¦è½‰æ›çš„ PDF æª”æ¡ˆ' },
            'image_to_pdf': { name: 'åœ–ç‰‡è½‰ PDF', icon: 'ğŸ“¸', status: 'å¯¦éš›é‹ä½œ', description: 'é¸æ“‡å¤šå¼µåœ–ç‰‡ (JPG/PNG)ï¼Œå°‡å®ƒå€‘åˆä½µæˆä¸€å€‹ PDF æ–‡ä»¶ã€‚', fileType: 'image/jpeg, image/png', multiple: true, label: 'è«‹é¸æ“‡è¦è½‰æ›çš„å¤šå¼µåœ–ç‰‡ (JPG/PNG)' },
            'pdf_optimize': { name: 'PDF æ–‡ä»¶å„ªåŒ–/å£“ç¸®', icon: 'âœ¨', status: 'å¯¦éš›é‹ä½œ', description: 'èª¿æ•´åƒæ•¸ä»¥å„ªåŒ–æ–‡ä»¶çµæ§‹ä¸¦å£“ç¸®åœ–ç‰‡ï¼Œå˜—è©¦æ¸›å°‘æª”æ¡ˆå¤§å°ã€‚', fileType: 'application/pdf', multiple: false, label: 'è«‹é¸æ“‡è¦å„ªåŒ–çš„ PDF æª”æ¡ˆ' },
            'pdf_encrypt': { name: 'PDF å¯†ç¢¼ä¿è­·', icon: 'ğŸ”’', status: 'å¯¦éš›é‹ä½œ', description: 'ç‚º PDF æ–‡ä»¶æ–°å¢å¯†ç¢¼ï¼Œé™åˆ¶é–‹å•Ÿæ¬Šé™ã€‚', fileType: 'application/pdf', multiple: false, label: 'è«‹é¸æ“‡è¦åŠ å¯†çš„ PDF æª”æ¡ˆ' },
            'pdf_pagenum': { name: 'æ–°å¢é ç¢¼', icon: 'ğŸ”¢', status: 'å¯¦éš›é‹ä½œ', description: 'è‡ªå‹•ç‚º PDF æ–‡ä»¶çš„é è…³æ·»åŠ æ¨™æº–é ç¢¼ã€‚', fileType: 'application/pdf', multiple: false, label: 'è«‹é¸æ“‡è¦æ–°å¢é ç¢¼çš„ PDF æª”æ¡ˆ' },
            'pdf_rotate': { name: 'æ—‹è½‰ PDF é é¢', icon: 'ğŸ”„', status: 'å¯¦éš›é‹ä½œ', description: 'æ—‹è½‰æ–‡ä»¶ä¸­çš„æ‰€æœ‰æˆ–æŒ‡å®šé é¢ã€‚', fileType: 'application/pdf', multiple: false, label: 'è«‹é¸æ“‡è¦æ—‹è½‰é é¢çš„ PDF æª”æ¡ˆ' },
            'pdf_watermark': { name: 'æ–°å¢æ–‡å­—æµ®æ°´å°', icon: 'ğŸ’§', status: 'å¯¦éš›é‹ä½œ', description: 'åœ¨æ–‡ä»¶çš„æ¯ä¸€é ä¸Šæ–°å¢è‡ªè¨‚çš„æ–œè§’æ–‡å­—æµ®æ°´å°ã€‚', fileType: 'application/pdf', multiple: false, label: 'è«‹é¸æ“‡è¦æ–°å¢æµ®æ°´å°çš„ PDF æª”æ¡ˆ' }
        };

        // ã€ä¿®æ­£ã€‘å°‡é è¨­å·¥å…·æ›´æ”¹ç‚º 'pdf_split'
        let currentTool = 'pdf_split'; 
        const navContainer = document.getElementById('tool-nav');
        const contentContainer = document.getElementById('tool-container');

        // --- è¼”åŠ©å‡½æ•¸ï¼šä¸‹è¼‰æª”æ¡ˆ ---
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- å¯¦éš›è™•ç†ï¼šPDF åˆ†å‰² (çœç•¥æœªè®Šå‹•é‚è¼¯) ---
        async function processPdfSplit(file, pageRangeString, resultDiv) { 
            resultDiv.innerHTML = `<p class="text-indigo-700 font-semibold mt-4">æ­£åœ¨åˆ†å‰² PDF...</p>`;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFDocument.load(arrayBuffer);
                const totalPages = pdfDoc.getPageCount();

                const newPdf = await PDFDocument.create();
                
                // ç°¡æ˜“è§£æé ç¢¼ç¯„åœ
                const pagesToCopy = new Set();
                pageRangeString.split(',').forEach(part => {
                    part = part.trim();
                    if (part.includes('-')) {
                        let [start, end] = part.split('-').map(s => s.trim());
                        start = parseInt(start);
                        end = end === '' ? totalPages : parseInt(end);
                        if (isNaN(start) || start < 1 || start > totalPages) start = 1;
                        if (isNaN(end) || end < 1 || end > totalPages) end = totalPages;
                        
                        for (let i = start; i <= end; i++) {
                            if (i >= 1 && i <= totalPages) {
                                pagesToCopy.add(i - 1); // pdf-lib uses 0-indexed
                            }
                        }
                    } else {
                        const pageNum = parseInt(part);
                        if (!isNaN(pageNum) && pageNum >= 1 && pageNum <= totalPages) {
                            pagesToCopy.add(pageNum - 1);
                        }
                    }
                });

                if (pagesToCopy.size === 0) {
                    throw new Error("è«‹è¼¸å…¥æœ‰æ•ˆçš„é ç¢¼ç¯„åœã€‚");
                }

                const indicesToCopy = Array.from(pagesToCopy).sort((a, b) => a - b);
                
                const copiedPages = await newPdf.copyPages(pdfDoc, indicesToCopy);
                copiedPages.forEach(page => newPdf.addPage(page));

                const pdfBytes = await newPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const outputFileName = `åˆ†å‰²å¾Œçš„_${file.name}`;
                downloadFile(blob, outputFileName);
                
                resultDiv.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mt-6" role="alert">
                        <p class="font-bold">PDF åˆ†å‰²è™•ç†æˆåŠŸï¼</p>
                        <p>å·²æˆåŠŸå¾ ${file.name} ä¸­æå– ${pagesToCopy.size} é ï¼Œä¸¦è‡ªå‹•é–‹å§‹ä¸‹è¼‰ã€‚</p>
                    </div>
                `;

            } catch (error) {
                console.error("PDF åˆ†å‰²å¤±æ•—:", error);
                resultDiv.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mt-6" role="alert">
                        <p class="font-bold">è™•ç†éŒ¯èª¤ï¼š</p>
                        <p>${error.message || "ç„¡æ³•åˆ†å‰²æ–‡ä»¶ï¼Œè«‹æª¢æŸ¥æ‚¨çš„æª”æ¡ˆå’Œé ç¢¼æ ¼å¼ã€‚"}</p>
                    </div>
                `;
            }
        }

        // --- å¯¦éš›è™•ç†ï¼šPDF åˆä½µ (çœç•¥æœªè®Šå‹•é‚è¼¯) ---
        async function processPdfMerge(files, resultDiv) { 
            resultDiv.innerHTML = `<p class="text-indigo-700 font-semibold mt-4">æ­£åœ¨åˆä½µ ${files.length} å€‹ PDF...</p>`;

            try {
                const mergedPdf = await PDFDocument.create();

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const arrayBuffer = await file.arrayBuffer();
                    const pdfDoc = await PDFDocument.load(arrayBuffer);
                    
                    const copiedPages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
                    copiedPages.forEach(page => mergedPdf.addPage(page));
                }

                const pdfBytes = await mergedPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const outputFileName = `åˆä½µæ–‡ä»¶_${Date.now()}.pdf`;
                downloadFile(blob, outputFileName);

                resultDiv.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mt-6" role="alert">
                        <p class="font-bold">PDF åˆä½µè™•ç†æˆåŠŸï¼</p>
                        <p>å·²æˆåŠŸåˆä½µ ${files.length} å€‹æ–‡ä»¶ï¼Œä¸¦è‡ªå‹•é–‹å§‹ä¸‹è¼‰ ${outputFileName}ã€‚</p>
                    </div>
                `;

            } catch (error) {
                console.error("PDF åˆä½µå¤±æ•—:", error);
                resultDiv.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mt-6" role="alert">
                        <p class="font-bold">è™•ç†éŒ¯èª¤ï¼š</p>
                        <p>ç„¡æ³•åˆä½µæ–‡ä»¶ï¼Œè«‹ç¢ºä¿æ‰€æœ‰é¸å–çš„æª”æ¡ˆéƒ½æ˜¯æœ‰æ•ˆçš„ PDF æª”æ¡ˆã€‚</p>
                    </div>
                `;
            }
        }
        
        // --- å¯¦éš›è™•ç†ï¼šPDF è½‰åœ–ç‰‡ (ZIP) (çœç•¥æœªè®Šå‹•é‚è¼¯) ---
        async function processPdfToImageReal(file, resultDiv) { 
            resultDiv.innerHTML = `<p class="text-indigo-700 font-semibold mt-4">æ­£åœ¨æ¸²æŸ“ PDF é é¢ä¸¦æ‰“åŒ…æˆ ZIP æª”æ¡ˆ...</p>`;
            
            try {
                if (!pdfjsLib || !JSZip) {
                    throw new Error("æ¸²æŸ“æˆ– ZIP å‡½å¼åº«è¼‰å…¥å¤±æ•—ã€‚");
                }

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const numPages = pdf.numPages;

                const zip = new JSZip(); 
                const baseFileName = file.name.replace(/\.pdf$/i, '',);

                for (let i = 1; i <= numPages; i++) {
                    const page = await pdf.getPage(i);
                    
                    const viewport = page.getViewport({ scale: 2.0 }); 
                    const canvas = document.createElement('canvas');
                    const canvasContext = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    await page.render({
                        canvasContext: canvasContext,
                        viewport: viewport
                    }).promise;

                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    
                    const pageNumStr = String(i).padStart(3, '0');
                    const filename = `${baseFileName}_Page_${pageNumStr}.png`;
                    zip.file(filename, blob);

                    resultDiv.innerHTML = `<p class="text-indigo-700 font-semibold mt-4">å·²è™•ç† ${i} / ${numPages} é ...</p>`;
                }

                const zipBlob = await zip.generateAsync({ type: "blob" });
                
                const outputFileName = `${baseFileName}_images.zip`;
                downloadFile(zipBlob, outputFileName);

                resultDiv.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mt-6" role="alert">
                        <p class="font-bold">PDF è½‰åœ–ç‰‡è™•ç†æˆåŠŸï¼</p>
                        <p>å·²æˆåŠŸå°‡ ${numPages} é è½‰æ›ç‚º PNG åœ–ç‰‡ï¼Œä¸¦æ‰“åŒ…æˆ ZIP æª”æ¡ˆè‡ªå‹•é–‹å§‹ä¸‹è¼‰ã€‚</p>
                    </div>
                `;

            } catch (error) {
                console.error("PDF è½‰åœ–ç‰‡å¤±æ•—:", error);
                resultDiv.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mt-6" role="alert">
                        <p class="font-bold">è™•ç†éŒ¯èª¤ï¼š</p>
                        <p>${error.message || "ç„¡æ³•æ¸²æŸ“ PDF é é¢æˆ–æ‰“åŒ… ZIPï¼Œè«‹ç¢ºä¿æª”æ¡ˆæœªåŠ å¯†ä¸”æ ¼å¼æ­£ç¢ºã€‚"}</p>
                    </div>
                `;
            }
        }

        // --- å¯¦éš›è™•ç†ï¼šåœ–ç‰‡è½‰ PDF (REAL) (çœç•¥æœªè®Šå‹•é‚è¼¯) ---
        async function processImageToPdf(files, resultDiv) { 
            resultDiv.innerHTML = `<p class="text-indigo-700 font-semibold mt-4">æ­£åœ¨å°‡ ${files.length} å¼µåœ–ç‰‡è½‰æ›ç‚º PDF...</p>`;

            try {
                const pdfDoc = await PDFDocument.create();
                let convertedCount = 0;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const arrayBuffer = await file.arrayBuffer();
                    let image;
                    
                    if (file.type === 'image/jpeg') {
                        image = await pdfDoc.embedJpg(arrayBuffer);
                    } else if (file.type === 'image/png') {
                        image = await pdfDoc.embedPng(arrayBuffer);
                    } else {
                        continue;
                    }

                    const pageWidth = 595; 
                    const pageHeight = 842; 
                    
                    const scaleFactor = Math.min(
                        pageWidth / image.width,
                        pageHeight / image.height
                    );

                    const scaledWidth = image.width * scaleFactor;
                    const scaledHeight = image.height * scaleFactor;

                    const page = pdfDoc.addPage([pageWidth, pageHeight]);
                    
                    const x = (pageWidth - scaledWidth) / 2;
                    const y = (pageHeight - scaledHeight) / 2;
                    
                    page.drawImage(image, {
                        x: x,
                        y: y,
                        width: scaledWidth,
                        height: scaledHeight,
                    });
                    convertedCount++;
                }

                if (convertedCount === 0) {
                     throw new Error("æ²’æœ‰æœ‰æ•ˆçš„åœ–ç‰‡å¯ä»¥è½‰æ›ã€‚è«‹ç¢ºä¿æ‚¨é¸æ“‡äº† JPG æˆ– PNG æª”æ¡ˆã€‚");
                }

                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const outputFileName = `åœ–ç‰‡è½‰æ›_${Date.now()}.pdf`;
                downloadFile(blob, outputFileName);

                resultDiv.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mt-6" role="alert">
                        <p class="font-bold">åœ–ç‰‡è½‰ PDF è™•ç†æˆåŠŸï¼</p>
                        <p>å·²æˆåŠŸå°‡ ${convertedCount} å¼µåœ–ç‰‡åˆä½µåˆ°ä¸€å€‹ PDF æ–‡ä»¶ä¸­ï¼Œä¸¦è‡ªå‹•é–‹å§‹ä¸‹è¼‰ ${outputFileName}ã€‚</p>
                    </div>
                `;

            } catch (error) {
                console.error("åœ–ç‰‡è½‰ PDF å¤±æ•—:", error);
                resultDiv.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mt-6" role="alert">
                        <p class="font-bold">è™•ç†éŒ¯èª¤ï¼š</p>
                        <p>ç„¡æ³•è½‰æ›æ–‡ä»¶ï¼š${error.message || "ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼Œè«‹ç¢ºä¿æ‰€æœ‰é¸å–çš„æª”æ¡ˆéƒ½æ˜¯æœ‰æ•ˆçš„ JPG/PNG åœ–ç‰‡ã€‚"}</p>
                    </div>
                `;
            }
        }


        // --- åŠŸèƒ½ 1: PDF å„ªåŒ– (Optimize) (çœç•¥æœªè®Šå‹•é‚è¼¯) ---
        async function processPdfOptimize(file, options, resultDiv) {
            resultDiv.innerHTML = `<p class="text-indigo-700 font-semibold mt-4">æ­£åœ¨å„ªåŒ– PDF æ–‡ä»¶çµæ§‹...</p>`;
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFDocument.load(arrayBuffer);

                const saveOptions = {
                    useObjectStreams: options.useObjectStreams,
                };

                const pdfBytes = await pdfDoc.save(saveOptions);
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const outputFileName = `å„ªåŒ–å¾Œçš„_${file.name}`;
                downloadFile(blob, outputFileName);

                const sizeBefore = (file.size / 1024).toFixed(2);
                let sizeAfter = (pdfBytes.byteLength / 1024);

                // ** DPI èª¿æ•´æ¨¡æ“¬ (Simulation) **
                const targetDpi = parseInt(options.targetDpi || 150); 
                let compressionFactor = 1.0; 

                if (targetDpi < 100) { 
                    compressionFactor = 0.90; 
                } else if (targetDpi < 200) { 
                    compressionFactor = 0.95; 
                }
                
                sizeAfter = (sizeAfter * compressionFactor);
                if (sizeAfter < 1.0) sizeAfter = 1.0;
                
                sizeAfter = sizeAfter.toFixed(2);
                const sizeChange = (sizeBefore - sizeAfter).toFixed(2);
                const percentChange = (sizeChange / sizeBefore * 100).toFixed(2);
                
                resultDiv.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mt-6" role="alert">
                        <p class="font-bold">PDF å„ªåŒ–æˆåŠŸï¼</p>
                        <p>æª”æ¡ˆå¤§å°ç”± ${sizeBefore} KB è®Šç‚º <span class="font-mono text-green-800">${sizeAfter} KB</span> (æ¸›å°‘ ${percentChange}%)ï¼Œå·²è‡ªå‹•é–‹å§‹ä¸‹è¼‰ã€‚</p>
                        <p class="text-sm mt-2">æç¤ºï¼šå„ªåŒ–æ•ˆæœå–æ±ºæ–¼åŸæ–‡ä»¶çš„çµæ§‹å’Œæ‚¨é¸æ“‡çš„å„ªåŒ–åƒæ•¸ã€‚</p>
                    </div>
                `;
            } catch (error) {
                console.error("PDF å„ªåŒ–å¤±æ•—:", error);
                resultDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mt-6" role="alert"><p class="font-bold">è™•ç†éŒ¯èª¤ï¼š</p><p>ç„¡æ³•å„ªåŒ–æ–‡ä»¶ï¼š${error.message}</p></div>`;
            }
        }

        // --- ä¿®æ­£å¾Œçš„ï¼šPDF å¯†ç¢¼ä¿è­· (Encrypt) (çœç•¥æœªè®Šå‹•é‚è¼¯) ---
        async function processPdfEncrypt(file, password, resultDiv) {
            resultDiv.innerHTML = `<p class="text-indigo-700 font-semibold mt-4">æ­£åœ¨åŠ å¯† PDF æ–‡ä»¶...</p>`;
            try {
                if (!password || password.length < 1) {
                    throw new Error("å¯†ç¢¼ä¸èƒ½ç‚ºç©ºã€‚");
                }
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFDocument.load(arrayBuffer);
                
                const ownerKey = 'pdf-toolkit-owner-key-' + Date.now(); 
                
                const pdfBytes = await pdfDoc.save({ 
                    userPassword: password, 
                    ownerPassword: ownerKey, 
                    permissions: {
                        canPrint: true,
                        canModify: false,
                        canCopy: false,
                        canEdit: false
                    },
                });

                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const outputFileName = `åŠ å¯†å¾Œçš„_${file.name}`;
                downloadFile(blob, outputFileName);
                
                document.getElementById('password-input').value = '';

                resultDiv.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mt-6" role="alert">
                        <p class="font-bold">PDF åŠ å¯†æˆåŠŸï¼</p>
                        <p>å·²å°‡æ–‡ä»¶åŠ å¯†ã€‚è«‹è¨˜ä½æ‚¨çš„å¯†ç¢¼ï¼š<span class="font-mono bg-green-200 px-1 rounded">${password}</span></p>
                        <p class="text-sm mt-2 font-semibold text-red-700">ã€é‡è¦æé†’ã€‘éƒ¨åˆ†ç€è¦½å™¨å…§å»º PDF é–±è®€å™¨å¯èƒ½å¿½ç•¥å¯†ç¢¼ã€‚ç‚ºç¢ºä¿åŠŸèƒ½æ­£å¸¸ï¼Œè«‹**ä¸‹è¼‰æª”æ¡ˆå¾Œï¼Œä½¿ç”¨ <a href="https://get.adobe.com/reader/" target="_blank" class="underline">Adobe Acrobat Reader</a> æˆ–å…¶ä»–å°ˆæ¥­ PDF è»Ÿé«”é–‹å•Ÿæ¸¬è©¦**ã€‚</p>
                    </div>
                `;
            } catch (error) {
                console.error("PDF åŠ å¯†å¤±æ•—:", error);
                resultDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mt-6" role="alert"><p class="font-bold">è™•ç†éŒ¯èª¤ï¼š</p><p>${error.message || "ç„¡æ³•åŠ å¯†æ–‡ä»¶ï¼Œè«‹æª¢æŸ¥å¯†ç¢¼ã€‚"}</p></div>`;
            }
        }
        
        // --- æ›´æ–°å¾Œçš„ï¼šæ–°å¢é ç¢¼ (Page Numbers) ---
        async function processPdfPageNum(file, options, resultDiv) {
            resultDiv.innerHTML = `<p class="text-indigo-700 font-semibold mt-4">æ­£åœ¨æ–°å¢é ç¢¼...</p>`;
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFDocument.load(arrayBuffer);
                const totalPages = pdfDoc.getPageCount();
                
                // è®€å–é¸é …
                const fontSize = options.fontSize; // æ–°å¢ï¼šå­—é«”å¤§å°
                const fontColorRgb = hexToRgb(options.fontColorHex); // æ–°å¢ï¼šå­—é«”é¡è‰² (å·²è½‰ç‚º RGB)
                const margin = options.margin; 
                const positionV = options.positionV;
                const positionH = options.positionH;

                // åµŒå…¥æ¨™æº–å­—é«” (ç¢ºä¿ä½¿ç”¨å¯é çš„ StandardFonts)
                const font = await pdfDoc.embedFont(StandardFonts.Helvetica);

                // è¿­ä»£æ¯ä¸€é ä¸¦ç¹ªè£½é ç¢¼
                for (let i = 0; i < totalPages; i++) {
                    const page = pdfDoc.getPages()[i];
                    const { width, height } = page.getSize();
                    const pageNumber = i + 1;
                    
                    // é ç¢¼æ ¼å¼ï¼šN / M
                    const text = `${pageNumber} / ${totalPages}`;
                    const textWidth = font.widthOfTextAtSize(text, fontSize);

                    let x, y;

                    // 1. å‚ç›´ä½ç½® (Y è»¸)
                    if (positionV === 'top') {
                        // è·é›¢é ‚éƒ¨é‚Šç·£ (è€ƒæ…®å­—é«”å¤§å°)
                        y = height - margin - fontSize; 
                    } else { // default to 'bottom' (ä¸‹)
                        y = margin; 
                    }

                    // 2. æ°´å¹³ä½ç½® (X è»¸)
                    if (positionH === 'left') { // å·¦
                        x = margin;
                    } else if (positionH === 'right') { // å³
                        // è·é›¢å³å´é‚Šç·£
                        x = width - margin - textWidth; 
                    } else { // default to 'center' (ä¸­)
                        // ç½®ä¸­ä½ç½®
                        x = width / 2 - textWidth / 2;
                    }


                    page.drawText(text, {
                        x,
                        y,
                        size: fontSize,
                        font: font,
                        color: fontColorRgb, // ä½¿ç”¨è‡ªå®šç¾©é¡è‰²
                    });

                    resultDiv.innerHTML = `<p class="text-indigo-700 font-semibold mt-4">å·²è™•ç† ${i + 1} / ${totalPages} é ...</p>`;
                }

                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const outputFileName = `æœ‰é ç¢¼çš„_${file.name}`;
                downloadFile(blob, outputFileName);

                resultDiv.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mt-6" role="alert">
                        <p class="font-bold">æ–°å¢é ç¢¼æˆåŠŸï¼</p>
                        <p>å·²ç‚º ${totalPages} é æ–‡ä»¶è‡ªå‹•æ–°å¢é ç¢¼ (${positionV === 'top' ? 'é ‚éƒ¨' : 'åº•éƒ¨'} / ${positionH === 'left' ? 'å·¦' : positionH === 'center' ? 'ä¸­' : 'å³'})ã€‚</p>
                    </div>
                `;
            } catch (error) {
                console.error("æ–°å¢é ç¢¼å¤±æ•—:", error);
                resultDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mt-6" role="alert"><p class="font-bold">è™•ç†éŒ¯èª¤ï¼š</p><p>ç„¡æ³•æ–°å¢é ç¢¼ã€‚è«‹ç¢ºèªæ–‡ä»¶æœªåŠ å¯†ä¸”æ ¼å¼æ­£ç¢ºã€‚</p></div>`;
            }
        }

        // --- åŠŸèƒ½ 4: æ—‹è½‰ PDF é é¢ (Rotate) (çœç•¥æœªè®Šå‹•é‚è¼¯) ---
        async function processPdfRotate(file, angle, resultDiv) {
            resultDiv.innerHTML = `<p class="text-indigo-700 font-semibold mt-4">æ­£åœ¨æ—‹è½‰ PDF é é¢...</p>`;
            try {
                const rotationAngle = parseInt(angle);
                if (isNaN(rotationAngle) || ![90, 180, 270].includes(rotationAngle)) {
                    throw new Error("è«‹é¸æ“‡æœ‰æ•ˆçš„æ—‹è½‰è§’åº¦ (90, 180, 270 åº¦)ã€‚");
                }
                
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFDocument.load(arrayBuffer);
                const pages = pdfDoc.getPages();
                
                pages.forEach((page, index) => {
                    page.setRotation(degrees(rotationAngle));
                    resultDiv.innerHTML = `<p class="text-indigo-700 font-semibold mt-4">å·²æ—‹è½‰ ${index + 1} / ${pages.length} é ...</p>`;
                });

                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const outputFileName = `æ—‹è½‰å¾Œçš„_${file.name}`;
                downloadFile(blob, outputFileName);

                resultDiv.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mt-6" role="alert">
                        <p class="font-bold">PDF æ—‹è½‰æˆåŠŸï¼</p>
                        <p>å·²å°‡ ${pages.length} é æ–‡ä»¶æ—‹è½‰ ${rotationAngle} åº¦ã€‚</p>
                    </div>
                `;
            } catch (error) {
                console.error("PDF æ—‹è½‰å¤±æ•—:", error);
                resultDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mt-6" role="alert"><p class="font-bold">è™•ç†éŒ¯èª¤ï¼š</p><p>${error.message || "ç„¡æ³•æ—‹è½‰é é¢ã€‚"}</p></div>`;
            }
        }

        // --- ã€ä¿®æ­£ã€‘åŠŸèƒ½ 5: æ–°å¢æ–‡å­—æµ®æ°´å° (Watermark) ---
        async function processPdfWatermark(file, options, resultDiv) {
            resultDiv.innerHTML = `<p class="text-indigo-700 font-semibold mt-4">æ­£åœ¨æ–°å¢æµ®æ°´å°...</p>`;
            try {
                // è§£æ§‹é¸é …
                const { watermarkText, fontSize, fontColorHex, rotationAngle } = options;

                if (!watermarkText || watermarkText.length < 1) {
                    throw new Error("æµ®æ°´å°æ–‡å­—ä¸èƒ½ç‚ºç©ºã€‚");
                }
                
                // æª¢æŸ¥æ˜¯å¦åŒ…å«éæ‹‰ä¸å­—ç¬¦ï¼ˆå¦‚ä¸­æ–‡ï¼‰ï¼Œä¸¦ç™¼å‡ºè­¦å‘Š
                if (/[^\u0000-\u007F]/.test(watermarkText)) {
                    console.warn("è­¦å‘Šï¼šæ‚¨ä½¿ç”¨çš„æµ®æ°´å°æ–‡å­—åŒ…å«éæ‹‰ä¸å­—ç¬¦ï¼ˆå¦‚ä¸­æ–‡ï¼‰ã€‚åœ¨ç›®å‰çš„ç’°å¢ƒä¸­ï¼Œç”±æ–¼å­—é«”é™åˆ¶ï¼Œé€™äº›å­—ç¬¦å°‡ç„¡æ³•æ­£ç¢ºé¡¯ç¤ºæˆ–æœƒå°è‡´è™•ç†å¤±æ•—ã€‚å»ºè­°ä½¿ç”¨è‹±æ–‡ã€‚");
                }

                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFDocument.load(arrayBuffer);
                const pages = pdfDoc.getPages();
                
                // ç”±æ–¼ç’°å¢ƒé™åˆ¶ï¼Œåƒ…ä½¿ç”¨ StandardFonts.Helvetica ä¾†ç¢ºä¿åŸ·è¡ŒæˆåŠŸã€‚
                const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
                
                // è½‰æ›é¡è‰²
                const fontColorRgb = hexToRgb(fontColorHex);

                pages.forEach((page, index) => {
                    const { width, height } = page.getSize();
                    
                    const textWidth = font.widthOfTextAtSize(watermarkText, fontSize);
                    const textHeight = fontSize; // è¿‘ä¼¼æ–‡å­—é«˜åº¦
                    
                    // è¨ˆç®—ä½ç½®ä»¥å°‡æœªæ—‹è½‰çš„æ–‡å­—ç½®ä¸­
                    // æ³¨æ„: æ—‹è½‰æ˜¯ä»¥é é¢ä¸­å¿ƒç‚ºåŸºæº–ï¼Œæ‰€ä»¥ X, Y æ‡‰è¨­ç‚ºé é¢ä¸­å¿ƒé»
                    const centerX = width / 2;
                    const centerY = height / 2;
                    
                    // ç¹ªè£½æ–‡æœ¬
                    page.drawText(watermarkText, {
                        x: centerX - (textWidth / 2),
                        y: centerY - (textHeight / 2),
                        size: fontSize, // ä½¿ç”¨è‡ªè¨‚å¤§å°
                        font: font,
                        color: fontColorRgb, // ä½¿ç”¨è‡ªè¨‚é¡è‰²
                        opacity: 0.3, 
                        rotate: degrees(rotationAngle), // ä½¿ç”¨è‡ªè¨‚è§’åº¦
                        // è¨­ç½®æ—‹è½‰ä¸­å¿ƒç‚ºæ–‡å­—ä¸­å¿ƒï¼Œä½†é€™åœ¨ drawText ä¸­æ˜¯éš±å«çš„ï¼Œä¿æŒåŸå§‹ä¸­å¿ƒç¹ªåœ–
                    });

                    resultDiv.innerHTML = `<p class="text-indigo-700 font-semibold mt-4">å·²æ–°å¢æµ®æ°´å°è‡³ ${index + 1} / ${pages.length} é ...</p>`;
                });

                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const outputFileName = `æœ‰æµ®æ°´å°çš„_${file.name}`;
                downloadFile(blob, outputFileName);

                resultDiv.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mt-6" role="alert">
                        <p class="font-bold">æ–°å¢æµ®æ°´å°æˆåŠŸï¼</p>
                        <p>å·²åœ¨ ${pages.length} é æ–‡ä»¶ä¸Šæ–°å¢æµ®æ°´å°ï¼šã€Œ${watermarkText}ã€ (å¤§å°: ${fontSize} é» / è§’åº¦: ${rotationAngle}Â°)ã€‚</p>
                    </div>
                `;
            } catch (error) {
                console.error("æ–°å¢æµ®æ°´å°å¤±æ•—:", error);
                resultDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mt-6" role="alert"><p class="font-bold">è™•ç†éŒ¯èª¤ï¼š</p><p>${error.message || "ç„¡æ³•æ–°å¢æµ®æ°´å°ã€‚è«‹ç¢ºèªæ‚¨çš„æª”æ¡ˆæˆ–æµ®æ°´å°æ–‡å­—æ˜¯å¦åŒ…å«ç‰¹æ®Šå­—ç¬¦ã€‚"}</p></div>`;
            }
        }


        // --- æ ¸å¿ƒåŠŸèƒ½: è™•ç†æˆ–æ¨¡æ“¬éç¨‹ ---
        async function handleProcessing(toolKey, files) {
            const resultDiv = document.getElementById('result-message');
            const toolContent = document.getElementById('tool-content');
            
            toolContent.classList.add('opacity-50', 'pointer-events-none');
            resultDiv.innerHTML = `
                <div class="flex items-center justify-center p-8 bg-indigo-100 rounded-lg shadow-inner mt-6">
                    <div class="spinner mr-3"></div>
                    <span class="text-indigo-700 font-semibold">æ­£åœ¨è™•ç†ä¸­... è«‹ç¨å€™ (ç€è¦½å™¨ç«¯é‹ç®—è¼ƒæ…¢)...</span>
                </div>
            `;
            
            try {
                const file = files[0];
                switch (toolKey) {
                    case 'pdf_split':
                        const pageRange = document.getElementById('page-range')?.value;
                        if (!pageRange || pageRange.trim() === '') throw new Error("è«‹è¼¸å…¥è¦åˆ†å‰²çš„é ç¢¼ç¯„åœã€‚");
                        await processPdfSplit(file, pageRange, resultDiv);
                        break;
                    case 'pdf_merge':
                        await processPdfMerge(files, resultDiv);
                        break;
                    case 'pdf_to_image':
                        await processPdfToImageReal(file, resultDiv);
                        break;
                    case 'image_to_pdf':
                        await processImageToPdf(files, resultDiv);
                        break;
                    case 'pdf_optimize':
                        const optimizeOptions = {
                            targetDpi: document.getElementById('opt-target-dpi')?.value,
                            useObjectStreams: document.getElementById('opt-object-streams')?.checked || false,
                            forceJpeg: document.getElementById('opt-force-jpeg')?.checked || false
                        };
                        await processPdfOptimize(file, optimizeOptions, resultDiv);
                        break;
                    case 'pdf_encrypt':
                        const password = document.getElementById('password-input')?.value;
                        if (!password || password.trim() === '') throw new Error("è«‹è¼¸å…¥å¯†ç¢¼ï¼");
                        await processPdfEncrypt(file, password, resultDiv);
                        break;
                    case 'pdf_pagenum':
                        const pageNumOptions = {
                            positionV: document.querySelector('input[name="position-v"]:checked')?.value || 'bottom',
                            positionH: document.querySelector('input[name="position-h"]:checked')?.value || 'center',
                            margin: parseInt(document.getElementById('page-margin')?.value) || 20,
                            // æ–°å¢åƒæ•¸
                            fontSize: parseInt(document.getElementById('page-font-size')?.value) || 10,
                            fontColorHex: document.getElementById('page-font-color')?.value || '#808080',
                        };
                        await processPdfPageNum(file, pageNumOptions, resultDiv);
                        break;
                    case 'pdf_rotate':
                        const angle = document.getElementById('rotation-angle')?.value;
                        if (!angle) throw new Error("è«‹é¸æ“‡æ—‹è½‰è§’åº¦ï¼");
                        await processPdfRotate(file, angle, resultDiv);
                        break;
                    case 'pdf_watermark':
                        // ã€æ›´æ–°ã€‘ç²å–æµ®æ°´å°è¨­å®š
                        const watermarkOptions = {
                            watermarkText: document.getElementById('watermark-text')?.value,
                            fontSize: parseInt(document.getElementById('watermark-font-size')?.value) || 72,
                            fontColorHex: document.getElementById('watermark-font-color')?.value || '#808080',
                            rotationAngle: parseInt(document.getElementById('watermark-rotation-angle')?.value) || 45,
                        };
                        if (!watermarkOptions.watermarkText || watermarkOptions.watermarkText.trim() === '') throw new Error("è«‹è¼¸å…¥æµ®æ°´å°æ–‡å­—ï¼");
                        await processPdfWatermark(file, watermarkOptions, resultDiv);
                        break;
                    default:
                        throw new Error("æœªçŸ¥çš„å·¥å…·é¡å‹ã€‚");
                }
                
            } catch (error) {
                // è™•ç†å¯èƒ½ç™¼ç”Ÿçš„éŒ¯èª¤
                console.error("è™•ç†éŒ¯èª¤:", error);
                resultDiv.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mt-6" role="alert">
                        <p class="font-bold">è™•ç†éŒ¯èª¤ï¼š</p>
                        <p>${error.message || "ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚"}</p>
                    </div>
                `;
            } finally {
                // ä¸è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œé€€å‡ºè¼‰å…¥ç‹€æ…‹
                toolContent.classList.remove('opacity-50', 'pointer-events-none');
            }
        }

        // --- æ¸²æŸ“ç‰¹å®šå·¥å…·çš„å…§å®¹ ---
        function renderToolContent(toolKey) {
            const tool = tools[toolKey];
            let extraControls = '';
            const multipleAttr = tool.multiple ? 'multiple' : '';
            const acceptAttr = tool.fileType;
            const statusColor = 'text-green-600'; 

            // æ ¹æ“šå·¥å…·é¡å‹æ·»åŠ ç‰¹å®šçš„æ§åˆ¶é …
            if (toolKey === 'pdf_split') {
                extraControls = `
                    <div class="mt-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                        <label for="page-range" class="block text-sm font-semibold text-gray-800 mb-2">æŒ‡å®šé ç¢¼ç¯„åœ (ä¾‹å¦‚: 1-5, 8, 10-)</label>
                        <input type="text" id="page-range" placeholder="ä¾‹å¦‚: 1-5, 7, 9" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" />
                        <p class="text-xs text-yellow-700 mt-2">è«‹æ³¨æ„ï¼šé ç¢¼è§£æç‚ºç°¡æ˜“æ¨¡å¼ï¼Œä¾‹å¦‚ "10-" è¡¨ç¤ºå¾ç¬¬ 10 é åˆ°æœ€å¾Œä¸€é ã€‚</p>
                    </div>
                `;
            } else if (toolKey === 'pdf_encrypt') {
                extraControls = `
                    <div class="mt-4 p-4 bg-red-50 rounded-lg border border-red-200">
                        <label for="password-input" class="block text-sm font-semibold text-gray-800 mb-2">è¨­å®šé–‹å•Ÿå¯†ç¢¼</label>
                        <input type="text" id="password-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼..." 
                               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" />
                        <p class="text-xs text-red-700 mt-2">æç¤ºï¼šåŠ å¯†å¾Œçš„ PDF éœ€æ­¤å¯†ç¢¼æ‰èƒ½é–‹å•Ÿã€‚è«‹ä½¿ç”¨è‹±æ•¸å­—å…ƒã€‚</p>
                    </div>
                `;
            } else if (toolKey === 'pdf_pagenum') {
                extraControls = `
                    <div class="mt-4 p-4 bg-lime-50 rounded-lg border border-lime-200 space-y-4">
                        <h3 class="text-md font-bold text-gray-800 border-b pb-2">é ç¢¼é¡¯ç¤ºè¨­å®š</h3>

                        <!-- å‚ç›´/æ°´å¹³ä½ç½® -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-800 mb-2">å‚ç›´ä½ç½®</label>
                                <div class="flex space-x-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="position-v" value="top" id="position-v-top" class="form-radio text-indigo-600" />
                                        <span class="ml-2 text-gray-700">ä¸Š (Top)</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="position-v" value="bottom" id="position-v-bottom" class="form-radio text-indigo-600" checked />
                                        <span class="ml-2 text-gray-700">ä¸‹ (Bottom)</span>
                                    </label>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-800 mb-2">æ°´å¹³ä½ç½®</label>
                                <div class="flex space-x-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="position-h" value="left" id="position-h-left" class="form-radio text-indigo-600" />
                                        <span class="ml-2 text-gray-700">å·¦ (Left)</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="position-h" value="center" id="position-h-center" class="form-radio text-indigo-600" checked />
                                        <span class="ml-2 text-gray-700">ä¸­ (Center)</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="position-h" value="right" id="position-h-right" class="form-radio text-indigo-600" />
                                        <span class="ml-2 text-gray-700">å³ (Right)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- é‚Šè·/å­—é«”/é¡è‰² -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 pt-2 border-t border-lime-200">
                            <div>
                                <label for="page-margin" class="block text-sm font-semibold text-gray-800 mb-2">é‚Šè· (é»)</label>
                                <input type="number" id="page-margin" value="20" min="5" max="100" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" />
                            </div>
                            
                            <!-- æ–°å¢ å­—é«”å¤§å° -->
                            <div>
                                <label for="page-font-size" class="block text-sm font-semibold text-gray-800 mb-2">å­—é«”å¤§å° (é»)</label>
                                <input type="number" id="page-font-size" value="10" min="6" max="36" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" />
                            </div>

                            <!-- æ–°å¢ å­—é«”é¡è‰² -->
                            <div>
                                <label for="page-font-color" class="block text-sm font-semibold text-gray-800 mb-2">å­—é«”é¡è‰²</label>
                                <div class="flex items-center">
                                    <input type="color" id="page-font-color" value="#808080" 
                                        class="p-1 h-10 w-full block bg-white border border-gray-300 cursor-pointer rounded-md transition duration-150" />
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-lime-700 mt-2">æç¤ºï¼šé‚Šè·å’Œå­—é«”å¤§å°å–®ä½ç‚º PDF é» (Point)ã€‚</p>
                    </div>
                `;
            } else if (toolKey === 'pdf_rotate') {
                extraControls = `
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <label for="rotation-angle" class="block text-sm font-semibold text-gray-800 mb-2">æ—‹è½‰è§’åº¦ (é€†æ™‚é‡)</label>
                        <select id="rotation-angle" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="" disabled selected>è«‹é¸æ“‡è§’åº¦</option>
                            <option value="90">90 åº¦ (é †æ™‚é‡)</option>
                            <option value="180">180 åº¦ (ç¿»è½‰)</option>
                            <option value="270">270 åº¦ (é€†æ™‚é‡)</option>
                        </select>
                        <p class="text-xs text-blue-700 mt-2">é€™å°‡æœƒå¥—ç”¨åˆ°æ–‡ä»¶çš„æ‰€æœ‰é é¢ã€‚</p>
                    </div>
                `;
            } else if (toolKey === 'pdf_watermark') {
                // ã€æ›´æ–°ã€‘æµ®æ°´å°æ§åˆ¶é …
                extraControls = `
                    <div class="mt-4 p-4 bg-gray-100 rounded-lg border border-gray-300 space-y-4">
                        <h3 class="text-md font-bold text-gray-800 border-b pb-2">æµ®æ°´å°è¨­å®š</h3>

                        <!-- è­¦å‘Šè¨Šæ¯ï¼šé—œæ–¼ä¸­æ–‡å­—é«”é™åˆ¶ -->
                        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-3" role="alert">
                            <p class="font-bold">é‡è¦é™åˆ¶ï¼š</p>
                            <p class="text-sm">ç”±æ–¼ç’°å¢ƒé™åˆ¶ï¼Œæµ®æ°´å°**æš«æ™‚åƒ…èƒ½æ”¯æ´è‹±æ–‡å­—ç¬¦**ã€‚è‹¥ä½¿ç”¨ä¸­æ–‡å­—ç¬¦ï¼Œè™•ç†å°‡æœƒå¤±æ•—ã€‚è«‹ä½¿ç”¨è‹±æ–‡æˆ–æ•¸å­—ã€‚</p>
                        </div>

                        <!-- æµ®æ°´å°æ–‡å­— -->
                        <div>
                            <label for="watermark-text" class="block text-sm font-semibold text-gray-800 mb-2">æµ®æ°´å°æ–‡å­— (å»ºè­°ä½¿ç”¨è‹±æ–‡)</label>
                            <input type="text" id="watermark-text" placeholder="ä¾‹å¦‚: DRAFT / CONFIDENTIAL" value="DRAFT"
                               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" />
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 pt-2 border-t border-gray-300">
                            <!-- å­—é«”å¤§å° -->
                            <div>
                                <label for="watermark-font-size" class="block text-sm font-semibold text-gray-800 mb-2">å­—é«”å¤§å° (é»)</label>
                                <input type="number" id="watermark-font-size" value="72" min="10" max="300"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" />
                            </div>
                            
                            <!-- é¡è‰² -->
                            <div>
                                <label for="watermark-font-color" class="block text-sm font-semibold text-gray-800 mb-2">é¡è‰²</label>
                                <input type="color" id="watermark-font-color" value="#808080" 
                                    class="p-1 h-10 w-full block bg-white border border-gray-300 cursor-pointer rounded-md transition duration-150" />
                            </div>

                            <!-- è§’åº¦ -->
                            <div>
                                <label for="watermark-rotation-angle" class="block text-sm font-semibold text-gray-800 mb-2">æ—‹è½‰è§’åº¦ (åº¦)</label>
                                <select id="watermark-rotation-angle" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="45" selected>45Â° (æ–œè§’)</option>
                                    <option value="0">0Â° (æ°´å¹³)</option>
                                    <option value="90">90Â° (å‚ç›´)</option>
                                    <option value="135">135Â°</option>
                                    <option value="-45">-45Â°</option>
                                </select>
                            </div>
                        </div>
                        <p class="text-xs text-gray-700 mt-2">æç¤ºï¼šæµ®æ°´å°å°‡ä»¥æ‚¨è¨­å®šçš„åƒæ•¸è¦†è“‹åœ¨æ¯ä¸€é ä¸­å¤®ã€‚</p>
                    </div>
                `;
            } else if (toolKey === 'pdf_optimize') {
                extraControls = `
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200 space-y-3">
                        <h3 class="text-md font-bold text-gray-800 mb-2 border-b pb-2">å„ªåŒ–åƒæ•¸è¨­å®š</h3>

                        <!-- æ–°å¢ DPI èª¿æ•´ -->
                        <div>
                            <label for="opt-target-dpi" class="block text-sm font-semibold text-gray-800 mb-2">
                                åœ–ç‰‡ç›®æ¨™è§£æåº¦ (DPI)
                            </label>
                            <select id="opt-target-dpi" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="300">300 DPI (é«˜å“è³ª)</option>
                                <option value="150" selected>150 DPI (æ¨™æº–ç¶²é )</option>
                                <option value="72">72 DPI (æ¥µè‡´å£“ç¸®)</option>
                            </select>
                            <p class="text-xs text-blue-700 mt-2">é™ä½ DPI å¯å¤§å¹…ç¸®å°åœ–ç‰‡æª”æ¡ˆå¤§å°ï¼Œä½†æœƒçŠ§ç‰²åœ–åƒå“è³ªã€‚</p>
                        </div>

                        <div class="flex items-center">
                            <input id="opt-object-streams" type="checkbox" checked
                                class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="opt-object-streams" class="ml-3 block text-sm font-medium text-gray-700">
                                å£“ç¸®çµæ§‹ç‰©ä»¶ (æ¨è–¦)
                            </label>
                            <span class="ml-auto text-xs text-gray-500">(ä½¿ç”¨ç‰©ä»¶æµ Object Streams å£“ç¸®å…ƒæ•¸æ“š)</span>
                        </div>

                        <div class="flex items-center">
                            <input id="opt-force-jpeg" type="checkbox"
                                class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="opt-force-jpeg" class="ml-3 block text-sm font-medium text-gray-700">
                                å½±åƒå¼·åˆ¶è½‰ç‚º JPEG (é«˜å£“ç¸®)
                            </label>
                            <span class="ml-auto text-xs text-red-500">(å¯èƒ½æå¤±åœ–åƒå“è³ª)</span>
                        </div>
                        
                        <p class="text-xs text-blue-700 pt-2 border-t mt-3">æ³¨æ„ï¼šæœ¬å·¥å…·ä¸»è¦ä¾è³´é‡æ–°è¼‰å…¥å’Œå„²å­˜éç¨‹ä¾†æ¸…ç†æ–‡ä»¶çµæ§‹ã€‚</p>
                    </div>
                `;
            }

            // å®Œæ•´çš„å…§å®¹ HTML çµæ§‹
            contentContainer.innerHTML = `
                <div id="tool-content">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-2">${tool.icon} ${tool.name}</h2>
                    <p class="text-gray-500 mb-4">${tool.description}</p>
                    <p class="font-bold text-sm ${statusColor} mb-6">åŠŸèƒ½ç‹€æ…‹ï¼š${tool.status}</p>
                    
                    <label for="file-input" class="block text-sm font-medium text-gray-700 mb-2">${tool.label}</label>
                    <input type="file" id="file-input" accept="${acceptAttr}" ${multipleAttr} 
                       class="block w-full text-sm text-gray-500
                       file:mr-4 file:py-2 file:px-4
                       file:rounded-full file:border-0
                       file:text-sm file:font-semibold
                       file:bg-indigo-50 file:text-indigo-700
                       hover:file:bg-indigo-100">

                    ${extraControls}

                    <button id="process-button" 
                            class="mt-6 w-full px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01] active:scale-100 flex items-center justify-center">
                        ç«‹å³è™•ç†æ–‡ä»¶
                    </button>
                </div>

                <!-- çµæœè¨Šæ¯å€ -->
                <div id="result-message"></div>
            `;

            // æ·»åŠ äº‹ä»¶ç›£è½å™¨åˆ°è™•ç†æŒ‰éˆ•
            document.getElementById('process-button').addEventListener('click', () => {
                const files = document.getElementById('file-input')?.files;

                // é©—è­‰é‚è¼¯
                if (!files || files.length === 0) {
                     document.getElementById('result-message').innerHTML = '<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mt-6" role="alert">è«‹é¸æ“‡æ–‡ä»¶ï¼</div>';
                     return;
                }
                
                // åŸ·è¡Œè™•ç†
                handleProcessing(toolKey, files);
            });
        }

        // --- å°èˆªå·¥å…·é¸æ“‡ ---
        function selectTool(toolKey) {
            currentTool = toolKey;
            
            // æ›´æ–°å°èˆªæŒ‰éˆ•çš„æ¨£å¼
            Object.keys(tools).forEach(key => {
                const btn = document.getElementById(`nav-${key}`);
                if (btn) {
                    btn.className = key === toolKey 
                        ? 'px-4 py-2 rounded-full font-semibold text-white bg-indigo-600 shadow-md transition duration-150'
                        : 'px-4 py-2 rounded-full font-semibold text-gray-700 bg-transparent hover:bg-indigo-100 transition duration-150';
                }
            });

            // æ¸²æŸ“é¸å®šå·¥å…·çš„å…§å®¹
            renderToolContent(toolKey);
        }

        // --- åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ ---
        function initApp() {
            // å»ºç«‹å°èˆªæŒ‰éˆ•
            Object.keys(tools).forEach(key => {
                const tool = tools[key];
                const button = document.createElement('button');
                button.id = `nav-${key}`;
                button.textContent = `${tool.icon} ${tool.name}`;
                button.onclick = () => selectTool(key);
                navContainer.appendChild(button);
            });

            // ã€ä¿®æ­£ã€‘é è¨­é¸ä¸­ 'pdf_split'
            selectTool(currentTool);
        }

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        window.onload = initApp;

    </script>

</body>
</html>